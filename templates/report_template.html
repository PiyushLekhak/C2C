<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pipeline Report - {{ timestamp }}</title>
  <style>
    body {
      background-color: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 20px;
    }

    h1, h2, h3 {
      color: #d4d4d4;
    }

    h1 {
      color: #56d6ad; /* Light blue */
    }

    h2 {
      color: #f39c12; /* Golden yellow */
    }

    h3 {
      color: #e74c3c; /* Red */
    }

    .section {
      margin-bottom: 50px;
    }

    .flex-row {
      display: flex;
      justify-content: space-between;
      align-items: stretch;
      gap: 20px;
    }

    .flex-col {
      flex: 1;
      padding: 0 5px;
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      margin-bottom: 20px;
    }

    table, th, td {
      border: 1px solid #444;
    }

    th, td {
      padding: 8px 12px;
      text-align: left;
    }

    th {
      background-color: #333; /* Darker gray for table headers */
    }

    .section img:only-child {
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    img {
      max-width: 100%;
      height: auto;
      margin: 10px auto;
      border: 1px solid #444;
      border-radius: 6px;
      display: block;
      background-color: #2a2a2a; /* slight contrast for image area */
    }

    pre {
      background-color: #2d2d2d;
      padding: 10px;
      border-radius: 8px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* Specific header colors for each section */
    .data-profiling-header {
      color: #3498db; /* Blue */
    }

    .data-cleaning-header {
      color: #2ecc71; /* Green */
    }

    .anomaly-detection-header {
      color: #e67e22; /* Orange */
    }

    .feature-importance-header {
      color: #9b59b6; /* Purple */
    }

    .model-evaluation-header {
      color: #16a085; /* Teal */
    }

    .policy-info-header {
      color: #f39c12; /* Golden yellow */
    }
  </style>
</head>

<body>
  <h1>ðŸ“Š Full Pipeline Report</h1>
  <p><strong>Run Timestamp:</strong> {{ timestamp }}</p>

  <div class="section">
    <h2 class="data-profiling-header">1. Data Profiling</h2>
    <table>
      <tr><th>Missing Values</th><td>{{ profiling.missing_values }}</td></tr>
      <tr><th>Duplicate Rows</th><td>{{ profiling.duplicate_rows }}</td></tr>
      <tr><th>Outliers</th><td>{{ profiling.outliers }}</td></tr>
      <tr><th>Inconsistencies</th><td>{{ profiling.inconsistencies }}</td></tr>
    </table>

    <div class="flex-row">
      {% if profiling.target_distribution_path %}
        <div class="flex-col">
          <h3>Target Distribution</h3>
          <img src="{{ profiling.target_distribution_path }}" alt="Target Distribution">
        </div>
      {% endif %}
      <div class="flex-col">
        <h3>Correlation Heatmap</h3>
        <img src="{{ profiling.correlation_heatmap_path }}" alt="Correlation Heatmap">
      </div>
    </div>

    <h3>Top 5 Correlated Feature Pairs</h3>
    <table>
      <tr><th>Feature 1</th><th>Feature 2</th><th>Correlation</th></tr>
      {% for pair in profiling.top_correlations %}
      <tr>
        <td>{{ pair['Feature 1'] }}</td>
        <td>{{ pair['Feature 2'] }}</td>
        <td>{{ pair['Correlation'] | round(2) }}</td>
      </tr>
      {% endfor %}
    </table>
  </div>

  <div class="section">
    <h2 class="data-cleaning-header">2. Data Cleaning Summary</h2>
    <table>
      <tr><th colspan="2">Missing Data Handling</th></tr>
      <tr><td>Dropped Columns</td><td>None</td></tr>
      <tr><td>Imputation Strategy</td><td>feature_1 â†’ Mean<br>feature_2 â†’ Mean</td></tr>
      <tr><th colspan="2">Duplicates</th></tr>
      <tr><td>Duplicates Removed</td><td>0</td></tr>
      <tr><th colspan="2">Outliers</th></tr>
      <tr><td>Method Used</td><td>Cap</td></tr>
      <tr><td>Columns Affected</td><td>None</td></tr>
      <tr><th colspan="2">Inconsistencies</th></tr>
      <tr><td>Fixes Applied</td><td>None</td></tr>
    </table>
  </div>

  <div class="section">
    <h2 class="anomaly-detection-header">3. Anomaly Detection</h2>
    {% if anomaly_summary.total_anomalies_flagged > 0 %}
      <p><strong>Total Anomalies Flagged:</strong> {{ anomaly_summary.total_anomalies_flagged }}</p>
      <p><strong>Contamination Rate:</strong> {{ (anomaly_summary.contamination_rate * 100) | round(2) }}%</p>
      <p><strong>Post-Action:</strong> {{ anomaly_summary.post_action }}</p>
      {% if anomaly_summary.anomaly_plot_path %}
        <img src="{{ anomaly_summary.anomaly_plot_path }}" alt="Anomaly Score Distribution">
      {% endif %}
    {% else %}
      <p>No anomalies detected or anomaly detection skipped.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2 class="feature-importance-header">4. Feature Importance</h2>
    <div class="flex-row">
      <div class="flex-col">
        <h3>Before Cleaning</h3>
        <img src="{{ feature_importance_before_path }}" alt="Feature Importance Before">
      </div>
      <div class="flex-col">
        <h3>After Cleaning</h3>
        <img src="{{ feature_importance_after_path }}" alt="Feature Importance After">
      </div>
    </div>
  </div>

  <div class="section">
    <h2 class="model-evaluation-header">5. Model Evaluation</h2>

    <div class="flex-row">
      <div class="flex-col">
        <h3>Before Cleaning</h3>
        <table>
          <tr><td>Weighted F1 Score</td><td>46.5%</td></tr>
          <tr><td>Accuracy</td><td>46.3%</td></tr>
        </table>
        <h4>Confusion Matrix</h4>
        <table>
          <tr><th></th><th>Predicted: 0</th><th>Predicted: 1</th></tr>
          <tr><th>Actual: 0</th><td>20</td><td>22</td></tr>
          <tr><th>Actual: 1</th><td>29</td><td>24</td></tr>
        </table>
      </div>
      <div class="flex-col">
        <h3>After Cleaning</h3>
        <table>
          <tr><td>Weighted F1 Score</td><td>48.9%</td></tr>
          <tr><td>Accuracy</td><td>49.0%</td></tr>
        </table>
        <h4>Confusion Matrix</h4>
        <table>
          <tr><th></th><th>Predicted: 0</th><th>Predicted: 1</th></tr>
          <tr><th>Actual: 0</th><td>23</td><td>26</td></tr>
          <tr><th>Actual: 1</th><td>25</td><td>26</td></tr>
        </table>
      </div>
    </div>

    <p><em>Note:</em> The F1 Score balances precision and recall â€” a higher value means better model performance. Accuracy reflects the overall percentage of correct predictions.</p>

    <h3>Performance Comparison</h3>
    <img src="{{ evaluation['Performance Plot'] }}" alt="Performance Comparison">
  </div>

  <div class="section">
    <h2 class="policy-info-header">6. Policy & Adaptation Info</h2>
    {% if policy_info %}
      <table>
        <tr><th>Policy</th><th>Method</th></tr>
        <tr><td><strong>Imputation Strategy</strong></td><td>{{ policy_info.imputation_strategy }}</td></tr>
        <tr><td><strong>Outlier Method</strong></td><td>{{ policy_info.outlier_method }}</td></tr>
      </table>
    {% else %}
      <p>No policy information recorded.</p>
    {% endif %}
  </div>

</body>
</html>
